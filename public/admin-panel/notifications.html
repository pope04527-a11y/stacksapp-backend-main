<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Notifications Management</title>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <script>
  (function(){
    // Inline admin auth helper (same pattern used across admin pages)
    function getToken(){
      return localStorage.getItem('stacksAdminToken') || localStorage.getItem('adminToken') || null;
    }

    function requireAuth(){
      const t = getToken();
      if (!t) {
        alert('Access denied. Please login.');
        window.location.href = '/admin-panel/login.html';
      }
      return t;
    }

    async function authFetch(url, opts){
      opts = Object.assign({}, opts || {});
      opts.headers = Object.assign({}, opts.headers || {});

      const token = getToken();
      if (token) {
        opts.headers['x-admin-token'] = token;
        if (!opts.headers['Authorization'] && !opts.headers['authorization']) {
          opts.headers['Authorization'] = 'Bearer ' + token;
        }
      }

      // Ensure the httpOnly cookie (if set by server) is sent as well
      opts.credentials = 'include';

      // If sending body and no content-type set, default to JSON
      if (opts.body && !opts.headers['Content-Type'] && !(opts.body instanceof FormData)) {
        opts.headers['Content-Type'] = 'application/json';
      }

      let res;
      try {
        res = await fetch(url, opts);
      } catch (err) {
        // network error -> bubble up
        throw err;
      }

      // Central handling of expired/unauthorized sessions
      if (res.status === 401 || res.status === 403) {
        // Clear client-side token(s) to force login
        try {
          localStorage.removeItem('stacksAdminToken');
          localStorage.removeItem('adminToken');
          // expire convenience cookie if present
          document.cookie = 'stacksAdminToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        } catch(e){/*ignore*/}
        // Redirect to login
        window.location.href = '/admin-panel/login.html';
        const err = new Error('Unauthorized');
        err.status = res.status;
        throw err;
      }

      return res;
    }

    // expose helpers globally for the page
    window.requireAuth = requireAuth;
    window.authFetch = authFetch;
    window.getAdminToken = getToken;

    // Ensure we have a token before proceeding
    requireAuth();
  })();
  </script>

  <div class="main-content" id="mainContent">
    <main class="dashboard-container">
      <section class="admin-section">
        <div class="section-header">
          <h2>Notifications Management</h2>
          <input type="text" id="searchInput" placeholder="Search by title or status..." oninput="searchNotifications()" />
          <button class="add-btn" onclick="showAddNotificationModal()"><i class="fa fa-plus"></i> Create Notification</button>
          <button class="export-btn" onclick="exportNotificationsCSV()"><i class="fa fa-download"></i> Export CSV</button>
        </div>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllNotifications" onclick="toggleSelectAllNotifications(this)"></th>
                <th>ID</th>
                <th>Title</th>
                <th>Message</th>
                <th>Status</th>
                <th>Recipients</th>
                <th>Created At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="notificationsTable">
              <!-- Notification rows injected dynamically -->
            </tbody>
          </table>
        </div>
        <div class="bulk-actions" id="bulkActions" style="display:none;">
          <button class="bulk-btn" onclick="bulkDeactivateNotifications()"><i class="fa fa-eye-slash"></i> Deactivate Selected</button>
          <button class="bulk-btn" onclick="bulkDeleteNotifications()"><i class="fa fa-trash"></i> Delete Selected</button>
        </div>
      </section>
    </main>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Add/Edit Notification Modal -->
  <div class="modal" id="notificationModal">
    <div class="modal-content">
      <span class="close" onclick="closeNotificationModal()">&times;</span>
      <h2 id="notificationModalTitle">Create Notification</h2>
      <form id="notificationForm">
        <input type="text" id="modalTitle" placeholder="Title" required />
        <textarea id="modalMessage" placeholder="Message" required></textarea>
        <select id="modalStatus" required>
          <option value="Active">Active</option>
          <option value="Inactive">Inactive</option>
        </select>
        <input type="text" id="modalRecipients" placeholder="Recipients (comma-separated usernames or 'all')" />
        <small>Leave blank or type <b>all</b> to notify everyone. Otherwise, use comma-separated usernames.</small>
        <button type="submit" class="add-btn">Save</button>
      </form>
    </div>
  </div>

  <script>
    // --- NOTIFICATIONS MANAGEMENT WITH RESTful API ---
    let selectedNotifications = new Set();
    let editingNotificationIndex = null;
    let allNotifications = [];

    // Safe fetchNotifications: treat 404 as empty list (do not logout), 401/403 triggers logout
    async function fetchNotifications() {
      try {
        const fetcher = (typeof authFetch === 'function') ? authFetch : async (u, o) => fetch(u, Object.assign({ credentials: 'include' }, o));
        const res = await fetcher('/admin/notifications');

        if (res.status === 404) {
          allNotifications = [];
          renderNotifications(allNotifications);
          return;
        }

        if (res.status === 401 || res.status === 403) {
          throw new Error('Unauthorized');
        }

        if (!res.ok) {
          console.error('Failed to fetch notifications', res.status);
          allNotifications = [];
          renderNotifications(allNotifications);
          return;
        }

        allNotifications = await res.json();
        renderNotifications(allNotifications);
      } catch (err) {
        console.error('fetchNotifications error:', err);
        alert("Session expired or unauthorized. Please login again.");
        logout();
      }
    }

    // Render notifications in table
    function renderNotifications(notifications) {
      const table = document.getElementById("notificationsTable");
      table.innerHTML = "";
      notifications.forEach((notif, idx) => {
        const checked = selectedNotifications.has(idx) ? "checked" : "";
        let recipientsStr = "";
        if (notif.recipients && Array.isArray(notif.recipients)) {
          recipientsStr = notif.recipients.includes('all') ? "All" : notif.recipients.join(", ");
        }
        table.innerHTML += `
          <tr>
            <td><input type="checkbox" onclick="selectNotification(${idx}, this)" ${checked}></td>
            <td>${notif.id || ""}</td>
            <td>${notif.title || ""}</td>
            <td>${notif.message || ""}</td>
            <td>
              <span class="status-badge ${
                notif.status === 'Active' ? 'status-active'
                : 'status-suspended'
              }">
                ${notif.status || "Inactive"}
              </span>
            </td>
            <td>${recipientsStr}</td>
            <td>${notif.createdAt ? new Date(notif.createdAt).toLocaleString() : ""}</td>
            <td class="action-icons">
              <button class="icon-btn" title="Edit" onclick="editNotification(${idx})"><i class="fa fa-edit"></i></button>
              <button class="icon-btn" title="Deactivate" onclick="deactivateNotification(${idx})"><i class="fa fa-eye-slash"></i></button>
              <button class="icon-btn" title="Delete" onclick="deleteNotification(${idx})"><i class="fa fa-trash"></i></button>
            </td>
          </tr>
        `;
      });
      document.getElementById("bulkActions").style.display = selectedNotifications.size > 0 ? "block" : "none";
    }

    // Select/deselect notification for bulk actions
    function selectNotification(idx, checkbox) {
      if (checkbox.checked) selectedNotifications.add(idx);
      else selectedNotifications.delete(idx);
      document.getElementById("bulkActions").style.display = selectedNotifications.size > 0 ? "block" : "none";
    }
    function toggleSelectAllNotifications(master) {
      selectedNotifications = new Set();
      if (master.checked) {
        allNotifications.forEach((_, idx) => selectedNotifications.add(idx));
      }
      renderNotifications(allNotifications);
      document.getElementById("selectAllNotifications").checked = master.checked;
    }

    // Search
    function searchNotifications() {
      const query = document.getElementById("searchInput").value.toLowerCase();
      const filtered = allNotifications.filter(notif =>
        (notif.title && notif.title.toLowerCase().includes(query)) ||
        (notif.message && notif.message.toLowerCase().includes(query)) ||
        (notif.status && notif.status.toLowerCase().includes(query)) ||
        (notif.recipients && Array.isArray(notif.recipients) && notif.recipients.join(", ").toLowerCase().includes(query))
      );
      renderNotifications(filtered);
    }

    // Add/Edit Notification
    function showAddNotificationModal() {
      editingNotificationIndex = null;
      document.getElementById("notificationModalTitle").textContent = "Create Notification";
      document.getElementById("notificationForm").reset();
      document.getElementById("modalRecipients").value = "";
      document.getElementById("notificationModal").style.display = "block";
    }
    function closeNotificationModal() {
      document.getElementById("notificationModal").style.display = "none";
    }

    document.getElementById("notificationForm").onsubmit = async function(e) {
      e.preventDefault();
      const title = document.getElementById("modalTitle").value.trim();
      const message = document.getElementById("modalMessage").value.trim();
      const status = document.getElementById("modalStatus").value;
      const recipientsRaw = document.getElementById("modalRecipients").value.trim();
      let recipients = [];
      if (!recipientsRaw || recipientsRaw.toLowerCase() === "all") {
        recipients = ["all"];
      } else {
        recipients = recipientsRaw.split(",").map(u => u.trim()).filter(Boolean);
      }

      try {
        if (editingNotificationIndex !== null) {
          // Edit
          const notif = allNotifications[editingNotificationIndex];
          const res = await authFetch(`/admin/notifications/${encodeURIComponent(notif.id)}`, {
            method: 'PUT',
            body: JSON.stringify({ title, message, status, recipients })
          });
          if (!res.ok) throw new Error('Failed to update notification');
          showToast("Notification updated!");
        } else {
          // Add
          const res = await authFetch('/admin/notifications', {
            method: 'POST',
            body: JSON.stringify({ title, message, status, recipients })
          });
          if (!res.ok) throw new Error('Failed to create notification');
          showToast("Notification created!");
        }
      } catch (err) {
        console.error('notification save error', err);
        showToast("Failed to save notification.");
      }

      closeNotificationModal();
      fetchNotifications();
    };

    function editNotification(idx) {
      editingNotificationIndex = idx;
      const notif = allNotifications[idx];
      document.getElementById("notificationModalTitle").textContent = "Edit Notification";
      document.getElementById("modalTitle").value = notif.title;
      document.getElementById("modalMessage").value = notif.message;
      document.getElementById("modalStatus").value = notif.status || "Inactive";
      document.getElementById("modalRecipients").value = notif.recipients ? (notif.recipients.includes("all") ? "all" : notif.recipients.join(", ")) : "";
      document.getElementById("notificationModal").style.display = "block";
    }

    // Deactivate (set status to Inactive)
    async function deactivateNotification(idx) {
      const notif = allNotifications[idx];
      try {
        const res = await authFetch(`/admin/notifications/${encodeURIComponent(notif.id)}/deactivate`, { method: 'PATCH' });
        if (!res.ok) throw new Error('Failed to deactivate');
        showToast("Notification deactivated.");
        fetchNotifications();
      } catch (e) {
        console.error('deactivate error', e);
        showToast("Failed to deactivate notification.");
      }
    }

    // Delete notification
    async function deleteNotification(idx) {
      const notif = allNotifications[idx];
      if (!confirm("Are you sure you want to delete this notification?")) return;
      try {
        const res = await authFetch(`/admin/notifications/${encodeURIComponent(notif.id)}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Failed to delete');
        showToast("Notification deleted.");
        fetchNotifications();
      } catch (e) {
        console.error('delete notification error', e);
        showToast("Failed to delete notification.");
      }
    }

    // Bulk actions
    async function bulkDeactivateNotifications() {
      if (selectedNotifications.size === 0) return;
      for (let idx of selectedNotifications) {
        const notif = allNotifications[idx];
        try {
          await authFetch(`/admin/notifications/${encodeURIComponent(notif.id)}/deactivate`, { method: 'PATCH' });
        } catch (e) {
          // continue
        }
      }
      showToast("Selected notifications deactivated.");
      fetchNotifications();
      selectedNotifications.clear();
    }
    async function bulkDeleteNotifications() {
      if (!confirm("Are you sure you want to delete selected notifications?")) return;
      for (let idx of selectedNotifications) {
        const notif = allNotifications[idx];
        try {
          await authFetch(`/admin/notifications/${encodeURIComponent(notif.id)}`, { method: 'DELETE' });
        } catch (e) {
          // continue
        }
      }
      selectedNotifications.clear();
      showToast("Selected notifications deleted.");
      fetchNotifications();
    }

    // Export notifications to CSV
    function exportNotificationsCSV() {
      const csv = [
        ["ID", "Title", "Message", "Status", "Recipients", "Created At"],
        ...allNotifications.map(n => [
          n.id, n.title, n.message, n.status, n.recipients ? (n.recipients.includes("all") ? "All" : n.recipients.join(", ")) : "",
          n.createdAt ? new Date(n.createdAt).toLocaleString() : ""
        ])
      ].map(row => row.map(String).map(s=>`"${s.replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "notifications.csv";
      a.click();
      URL.revokeObjectURL(url);
      showToast("Exported to CSV!");
    }

    // Toast and logout helpers
    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.className = "toast show";
      setTimeout(() => { toast.className = "toast"; }, 3000);
    }
    function logout() {
      try {
        localStorage.removeItem('stacksAdminToken');
        localStorage.removeItem('adminToken');
        document.cookie = 'stacksAdminToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
      } catch(e){}
      window.location.href = "/admin-panel/login.html";
    }

    // Modal close on outside click
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = "none";
      }
    }

    // Initial load
    fetchNotifications();
  </script>
<script>
window.addEventListener("message", function(event) {
  if (event.data && event.data.type === "setDarkMode") {
    if (event.data.enable) {
      document.body.classList.add("dark");
      document.documentElement.classList.add("dark");
    } else {
      document.body.classList.remove("dark");
      document.documentElement.classList.remove("dark");
    }
  }
});
// On load, also check localStorage (for direct navigation)
if (localStorage.getItem("adminDarkMode") === "true") {
  document.body.classList.add("dark");
  document.documentElement.classList.add("dark");
}
</script>
</body>
</html>
