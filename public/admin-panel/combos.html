<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Combos Management</title>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .product-grid { display: flex; flex-wrap: wrap; gap: 8px; max-height: 240px; overflow-y: auto; margin-bottom: 8px; }
    .product-tile {
      border: 2px solid #eee; border-radius: 6px; width: 68px; cursor: pointer;
      display: flex; flex-direction: column; align-items: center; padding: 4px;
      transition: border 0.2s;
    }
    .product-tile.selected { border: 2px solid #1976d2; background: #eaf1fd; }
    .product-tile img { width: 54px; height: 54px; object-fit: contain; }
    .product-tile span { font-size: 10px; text-align: center; margin-top: 2px; word-break: break-all; }
    .selected-products-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    .selected-products-table th, .selected-products-table td { font-size: 12px; padding: 2px 6px; border: 1px solid #ddd; }
    .selected-products-table th { background: #f5f5f5; }
    .remove-prod-btn { color: #d23; cursor: pointer; }
    .selected-products-table input[type="number"] { width: 60px; }
    .filter-row { display: flex; gap: 8px; margin-bottom: 4px; }
  </style>
</head>
<body>
  <script>
  (function(){
    // Inline admin auth helper (drop into each HTML admin page)
    function getToken(){
      return localStorage.getItem('stacksAdminToken') || localStorage.getItem('adminToken') || null;
    }

    function requireAuth(){
      const t = getToken();
      if (!t) {
        alert('Access denied. Please login.');
        window.location.href = '/admin-panel/login.html';
      }
      return t;
    }

    async function authFetch(url, opts){
      opts = Object.assign({}, opts || {});
      opts.headers = Object.assign({}, opts.headers || {});

      const token = getToken();
      if (token) {
        opts.headers['x-admin-token'] = token;
        if (!opts.headers['Authorization'] && !opts.headers['authorization']) {
          opts.headers['Authorization'] = 'Bearer ' + token;
        }
      }

      // Ensure the httpOnly cookie (if set by server) is sent as well
      opts.credentials = 'include';

      // If sending body and no content-type set, default to JSON
      if (opts.body && !opts.headers['Content-Type'] && !(opts.body instanceof FormData)) {
        opts.headers['Content-Type'] = 'application/json';
      }

      let res;
      try {
        res = await fetch(url, opts);
      } catch (err) {
        // network error -> bubble up
        throw err;
      }

      // Central handling of expired/unauthorized sessions
      if (res.status === 401 || res.status === 403) {
        // Clear client-side token(s) to force login
        try {
          localStorage.removeItem('stacksAdminToken');
          localStorage.removeItem('adminToken');
          // expire convenience cookie if present
          document.cookie = 'stacksAdminToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        } catch(e){/*ignore*/}
        // Redirect to login
        window.location.href = '/admin-panel/login.html';
        const err = new Error('Unauthorized');
        err.status = res.status;
        throw err;
      }

      return res;
    }

    // expose small API
    window.requireAuth = requireAuth;
    window.authFetch = authFetch;
    window.getAdminToken = getToken;

    // Immediately require auth when script loads (same behavior as your users.html top-check)
    requireAuth();
  })();
  </script>

  <div class="main-content" id="mainContent">
    <main class="dashboard-container">
      <section class="admin-section">
        <div class="section-header">
          <h2>Combos Management</h2>
          <input type="text" id="searchInput" placeholder="Search by username or trigger task..." oninput="searchCombos()" />
          <button class="add-btn" onclick="showAddComboModal()"><i class="fa fa-plus"></i> Assign Combo</button>
          <button class="export-btn" onclick="exportCombosCSV()"><i class="fa fa-download"></i> Export CSV</button>
        </div>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllCombos" onclick="toggleSelectAllCombos(this)"></th>
                <th>Combo ID</th>
                <th>Username</th>
                <th>Trigger Task #</th>
                <th>Products</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="combosTable"></tbody>
          </table>
        </div>
        <div class="bulk-actions" id="bulkActions" style="display:none;">
          <button class="bulk-btn" onclick="bulkDeleteCombos()"><i class="fa fa-trash"></i> Delete Selected</button>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Add/Edit Combo Modal -->
  <div class="modal" id="comboModal">
    <div class="modal-content" style="max-width:520px">
      <span class="close" onclick="closeComboModal()">&times;</span>
      <h2 id="comboModalTitle">Assign Combo</h2>
      <form id="comboForm" autocomplete="off">
        <input type="text" id="modalUsername" placeholder="Username" required />
        <input type="number" id="modalTriggerTask" placeholder="Trigger Task Number" min="1" required style="margin-bottom:8px;" />

        <label style="font-weight: 500; margin-top:4px; display:block;">Pick Products:</label>
        <div class="filter-row">
          <input type="number" id="minPriceInput" placeholder="Min price" style="width:90px;" oninput="onPriceFilterChange()" />
          <input type="number" id="maxPriceInput" placeholder="Max price" style="width:90px;" oninput="onPriceFilterChange()" />
        </div>
        <input type="text" id="productSearch" placeholder="Search products..." style="width:100%;margin-bottom:4px;" oninput="renderProductGrid()" />
        <div class="product-grid" id="productGrid"></div>

        <label style="font-weight: 500; margin-top:8px; display:block;">Selected Products:</label>
        <table class="selected-products-table">
          <thead>
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>Price</th>
              <th>Commission</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="selectedProductsTable"></tbody>
        </table>

        <button type="submit" class="add-btn">Save</button>
      </form>
    </div>
  </div>

  <script>
    // --- COMBOS MANAGEMENT WITH RESTful API ---
    let selectedCombos = new Set();
    let editingComboIndex = null;
    let allCombos = [];

    // For modal product selection
    let selectedProducts = []; // [{name, image, price, commission}]
    let productsList = [];
    let lastPriceFilter = {min: "", max: ""};

    async function fetchCombos() {
      try {
        const res = await authFetch('/admin/combos');
        if (!res.ok) throw new Error('Unauthorized');
        allCombos = await res.json();
        renderCombos(allCombos);
      } catch (err) {
        alert("Session expired or unauthorized. Please login again.");
        logout();
      }
    }

    function renderCombos(combos) {
      const table = document.getElementById("combosTable");
      table.innerHTML = "";
      combos.forEach((combo, idx) => {
        const checked = selectedCombos.has(idx) ? "checked" : "";
        const comboId = combo.id || combo._id || "";
        const productsHtml = (Array.isArray(combo.products) ? combo.products : []).map(p =>
          `<img src="${p.image}" alt="" style="width:22px;height:22px;vertical-align:middle;margin-right:2px;"> ${p.name} <span style="color:#555;">[£${p.price} | £${p.commission}]</span>`
        ).join("<br>");
        table.innerHTML += `
          <tr>
            <td><input type="checkbox" onclick="selectCombo(${idx}, this)" ${checked}></td>
            <td>${comboId}</td>
            <td>${combo.username}</td>
            <td>${combo.triggerTaskNumber}</td>
            <td>${productsHtml}</td>
            <td class="action-icons">
              <button class="icon-btn" title="Edit" onclick="editCombo(${idx})"><i class="fa fa-edit"></i></button>
              <button class="icon-btn" title="Delete" onclick="deleteCombo(${idx})"><i class="fa fa-trash"></i></button>
            </td>
          </tr>
        `;
      });
      document.getElementById("bulkActions").style.display = selectedCombos.size > 0 ? "block" : "none";
    }

    // --- Product Picker Modal Logic ---
    async function fetchCloudinaryProducts() {
      const min = document.getElementById("minPriceInput").value;
      const max = document.getElementById("maxPriceInput").value;
      let url = "/admin/cloudinary-products";
      const params = [];
      if (min) params.push("minPrice=" + encodeURIComponent(min));
      if (max) params.push("maxPrice=" + encodeURIComponent(max));
      if (params.length) url += "?" + params.join("&");
      lastPriceFilter = {min, max};
      try {
        const res = await authFetch(url);
        const data = await res.json();
        productsList = data.products || [];
        renderProductGrid();
      } catch (e) {
        showToast("Failed to load products.");
      }
    }

    function onPriceFilterChange() {
      fetchCloudinaryProducts();
    }

    function renderProductGrid() {
      const grid = document.getElementById("productGrid");
      const productSearchTerm = document.getElementById("productSearch").value.trim().toLowerCase();
      grid.innerHTML = "";
      let filtered = productsList.filter(p =>
        p.name.toLowerCase().includes(productSearchTerm) ||
        (p.price && String(p.price).includes(productSearchTerm))
      );
      filtered.forEach((prod) => {
        const isSelected = selectedProducts.some(sp => sp.image === prod.image);
        grid.innerHTML += `
          <div class="product-tile${isSelected ? ' selected' : ''}" onclick="toggleProduct('${prod.image.replace(/'/g,"\\'")}')">
            <img src="${prod.image}" alt="">
            <span>${prod.name}<br>£${prod.price}</span>
          </div>
        `;
      });
    }

    window.toggleProduct = function(image) {
      const prod = productsList.find(p => p.image === image);
      const idx = selectedProducts.findIndex(sp => sp.image === image);
      if (idx >= 0) {
        selectedProducts.splice(idx,1);
      } else {
        selectedProducts.push({...prod, price:prod.price ?? "", commission:""});
      }
      renderProductGrid();
      renderSelectedProductsTable();
    };

    function renderSelectedProductsTable() {
      const table = document.getElementById("selectedProductsTable");
      table.innerHTML = "";
      selectedProducts.forEach((prod, idx) => {
        table.innerHTML += `
          <tr>
            <td><img src="${prod.image}" style="width:34px;height:34px;"></td>
            <td>${prod.name}</td>
            <td>
              <input type="number" min="0" step="0.01" value="${prod.price ?? ""}" onchange="updateProductField(${idx}, 'price', this.value)" required>
            </td>
            <td>
              <input type="number" min="0" step="0.01" value="${prod.commission ?? ""}" onchange="updateProductField(${idx}, 'commission', this.value)" required>
            </td>
            <td>
              <span class="remove-prod-btn" onclick="removeSelectedProduct(${idx})"><i class="fa fa-times"></i></span>
            </td>
          </tr>
        `;
      });
    }

    window.updateProductField = function(idx, field, value) {
      selectedProducts[idx][field] = value;
    };

    window.removeSelectedProduct = function(idx) {
      selectedProducts.splice(idx,1);
      renderProductGrid();
      renderSelectedProductsTable();
    };

    function showAddComboModal() {
      editingComboIndex = null;
      selectedProducts = [];
      document.getElementById("comboModalTitle").textContent = "Assign Combo";
      document.getElementById("comboForm").reset();
      document.getElementById("productSearch").value = "";
      document.getElementById("minPriceInput").value = "";
      document.getElementById("maxPriceInput").value = "";
      fetchCloudinaryProducts();
      renderSelectedProductsTable();
      document.getElementById("comboModal").style.display = "block";
    }
    function closeComboModal() {
      document.getElementById("comboModal").style.display = "none";
    }

    document.getElementById("comboForm").onsubmit = async function(e) {
      e.preventDefault();
      const username = document.getElementById("modalUsername").value.trim();
      const triggerTaskNumber = Number(document.getElementById("modalTriggerTask").value);

      // Validate selected products
      if (selectedProducts.length === 0) {
        showToast("Pick at least one product!");
        return;
      }
      for (const prod of selectedProducts) {
        if (prod.price === "" || prod.commission === "") {
          showToast("Set price & commission for each product!");
          return;
        }
      }

      const products = selectedProducts.map(({name,image,price,commission}) => ({
        name, image,
        price: Number(price), commission: Number(commission)
      }));

      try {
        if (editingComboIndex !== null) {
          // Edit
          const combo = allCombos[editingComboIndex];
          const comboId = combo.id || combo._id;
          await authFetch(`/admin/combos/${encodeURIComponent(comboId)}`, {
            method: 'PUT',
            body: JSON.stringify({ username, triggerTaskNumber, products })
          });
          showToast("Combo updated!");
        } else {
          // Add
          await authFetch('/admin/combos', {
            method: 'POST',
            body: JSON.stringify({ username, triggerTaskNumber, products })
          });
          showToast("Combo assigned!");
        }
      } catch (e) {
        showToast("Failed to save combo.");
      }

      closeComboModal();
      fetchCombos();
    };

    function editCombo(idx) {
      editingComboIndex = idx;
      const combo = allCombos[idx];
      document.getElementById("comboModalTitle").textContent = "Edit Combo";
      document.getElementById("comboForm").reset();
      document.getElementById("modalUsername").value = combo.username;
      document.getElementById("modalTriggerTask").value = combo.triggerTaskNumber;
      selectedProducts = (Array.isArray(combo.products) ? combo.products : []).map(p => ({
        name: p.name, image: p.image, price: p.price, commission: p.commission
      }));
      document.getElementById("productSearch").value = "";
      document.getElementById("minPriceInput").value = "";
      document.getElementById("maxPriceInput").value = "";
      fetchCloudinaryProducts();
      renderSelectedProductsTable();
      document.getElementById("comboModal").style.display = "block";
    }

    async function deleteCombo(idx) {
      const combo = allCombos[idx];
      const comboId = combo.id || combo._id;
      if (confirm("Are you sure you want to delete this combo?")) {
        try {
          await authFetch(`/admin/combos/${encodeURIComponent(comboId)}`, { method: 'DELETE' });
          showToast("Combo deleted.");
          fetchCombos();
        } catch (e) {
          showToast("Failed to delete combo.");
        }
      }
    }

    async function bulkDeleteCombos() {
      if (confirm("Are you sure you want to delete selected combos?")) {
        for (let idx of selectedCombos) {
          const combo = allCombos[idx];
          const comboId = combo.id || combo._id;
          try {
            await authFetch(`/admin/combos/${encodeURIComponent(comboId)}`, { method: 'DELETE' });
          } catch (e) {
            // continue
          }
        }
        selectedCombos.clear();
        showToast("Selected combos deleted.");
        fetchCombos();
      }
    }

    function exportCombosCSV() {
      const csv = [
        ["Combo ID", "Username", "Trigger Task #", "Products"],
        ...allCombos.map(c => [
          c.id || c._id, c.username, c.triggerTaskNumber,
          (Array.isArray(c.products) ? c.products.map(p=>`${p.name} (£${p.price}/£${p.commission})`).join('; ') : "")
        ])
      ].map(row => row.map(String).map(s=>`"${s.replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "combos.csv";
      a.click();
      URL.revokeObjectURL(url);
      showToast("Exported to CSV!");
    }

    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.className = "toast show";
      setTimeout(() => { toast.className = "toast"; }, 3000);
    }
    function logout() {
      try {
        localStorage.removeItem('stacksAdminToken');
        localStorage.removeItem('adminToken');
        document.cookie = 'stacksAdminToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
      } catch(e){}
      window.location.href = "/admin-panel/login.html";
    }

    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = "none";
      }
    }

    function toggleSelectAllCombos(checkbox) {
      if (checkbox.checked) {
        selectedCombos = new Set(allCombos.map((_, idx) => idx));
      } else {
        selectedCombos.clear();
      }
      renderCombos(allCombos);
    }
    window.toggleSelectAllCombos = toggleSelectAllCombos;

    function selectCombo(idx, checkbox) {
      if (checkbox.checked) {
        selectedCombos.add(idx);
      } else {
        selectedCombos.delete(idx);
      }
      renderCombos(allCombos);
    }
    window.selectCombo = selectCombo;

    function searchCombos() {
      const term = document.getElementById('searchInput').value.trim().toLowerCase();
      const filtered = allCombos.filter(combo =>
        (combo.username && combo.username.toLowerCase().includes(term)) ||
        (combo.triggerTaskNumber && (combo.triggerTaskNumber + '').includes(term))
      );
      renderCombos(filtered);
    }
    window.searchCombos = searchCombos;

    fetchCombos();
  </script>
<script>
window.addEventListener("message", function(event) {
  if (event.data && event.data.type === "setDarkMode") {
    if (event.data.enable) {
      document.body.classList.add("dark");
      document.documentElement.classList.add("dark");
    } else {
      document.body.classList.remove("dark");
      document.documentElement.classList.remove("dark");
    }
  }
});
if (localStorage.getItem("adminDarkMode") === "true") {
  document.body.classList.add("dark");
  document.documentElement.classList.add("dark");
}
</script>
</body>
</html>
